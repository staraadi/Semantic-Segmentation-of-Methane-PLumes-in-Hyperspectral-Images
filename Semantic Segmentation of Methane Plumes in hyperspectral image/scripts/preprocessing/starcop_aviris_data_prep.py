NAME_FILES_PERMIAN = ['ang20190922t192642', 'ang20190922t194340', 'ang20190922t203229', 'ang20190923t163307', 'ang20190923t170747',
                      'ang20190923t172416', 'ang20190923t174142', 'ang20190923t181729', 'ang20190923t183439', 'ang20190923t185208',
                      'ang20190923t190921', 'ang20190923t192543', 'ang20190923t194235', 'ang20190923t195907', 'ang20190924t165509',
                      'ang20190924t165836', 'ang20190924t172057', 'ang20190924t174538', 'ang20190924t181121', 'ang20190924t183641',
                      'ang20190924t193726', 'ang20190926t152524', 'ang20190926t154314', 'ang20190926t160016', 'ang20190926t161748',
                      'ang20190926t163428', 'ang20190926t165202', 'ang20190926t171159', 'ang20190926t172904', 'ang20190926t174644',
                      'ang20190926t180335', 'ang20190926t182043', 'ang20190926t184029', 'ang20190926t185727', 'ang20190926t191417',
                      'ang20190926t193117', 'ang20190926t213844', 'ang20190926t220008', 'ang20190926t221757', 'ang20190926t223557',
                      'ang20190927t145113', 'ang20190927t151239', 'ang20190927t153023', 'ang20190927t154855', 'ang20190927t160700',
                      'ang20190927t162514', 'ang20190927t164322', 'ang20190927t170107', 'ang20190927t171836', 'ang20190927t173620',
                      'ang20190927t175410', 'ang20190927t181142', 'ang20190927t182905', 'ang20190927t184620', 'ang20190927t190436',
                      'ang20190927t192237', 'ang20190927t194104', 'ang20190928t175550', 'ang20190928t181405', 'ang20190928t183313',
                      'ang20190928t185111', 'ang20190928t190948', 'ang20190928t192731', 'ang20190928t193847', 'ang20191005t210402',
                      'ang20191005t215301', 'ang20191005t221554', 'ang20191006t150453', 'ang20191006t152009', 'ang20191006t153731',
                      'ang20191006t155231', 'ang20191006t160931', 'ang20191006t162415', 'ang20191006t164135', 'ang20191006t165608',
                      'ang20191006t171344', 'ang20191006t172739', 'ang20191006t174505', 'ang20191006t180341', 'ang20191006t182329',
                      'ang20191006t183904', 'ang20191006t185838', 'ang20191006t191332', 'ang20191007t175016', 'ang20191007t180411',
                      'ang20191007t182352', 'ang20191007t184008', 'ang20191007t185303', 'ang20191007t190840', 'ang20191007t193705',
                      'ang20191007t195115', 'ang20191007t200647', 'ang20191007t201917', 'ang20191008t151045', 'ang20191008t153517',
                      'ang20191008t160209', 'ang20191008t165855', 'ang20191008t172458', 'ang20191008t182150', 'ang20191008t183946',
                      'ang20191008t190449', 'ang20191008t194115', 'ang20191008t195936', 'ang20191010t152203', 'ang20191010t155034',
                      'ang20191010t161700', 'ang20191010t174755', 'ang20191010t182147', 'ang20191010t184216', 'ang20191010t185941',
                      'ang20191010t192008', 'ang20191010t193818', 'ang20191010t195717', 'ang20191011t152413', 'ang20191011t154103',
                      'ang20191011t160043', 'ang20191011t161719', 'ang20191011t163647', 'ang20191011t165345', 'ang20191011t171218',
                      'ang20191011t172641', 'ang20191011t174241', 'ang20191011t175712', 'ang20191011t181301', 'ang20191011t182731',
                      'ang20191011t184311', 'ang20191011t185825', 'ang20191011t191345', 'ang20191011t192741', 'ang20191011t194308',
                      'ang20191012t154407', 'ang20191012t154800', 'ang20191012t155942', 'ang20191012t162223', 'ang20191013t144828',
                      'ang20191013t145516', 'ang20191013t151222', 'ang20191013t152730', 'ang20191013t154421', 'ang20191013t155909',
                      'ang20191013t161540', 'ang20191013t163024', 'ang20191013t164602', 'ang20191013t170032', 'ang20191013t171742',
                      'ang20191013t173258', 'ang20191013t174928', 'ang20191013t180441', 'ang20191013t182140', 'ang20191013t185356',
                      'ang20191013t192848', 'ang20191016t143714', 'ang20191016t145145', 'ang20191016t150743', 'ang20191016t152245',
                      'ang20191016t153826', 'ang20191016t155337', 'ang20191016t160914', 'ang20191016t162417', 'ang20191016t163955',
                      'ang20191016t165454', 'ang20191016t171023', 'ang20191016t172526', 'ang20191016t174016', 'ang20191016t175642',
                      'ang20191016t181351', 'ang20191016t183045', 'ang20191016t184817', 'ang20191016t190528', 'ang20191016t193637',
                      'ang20191016t195058', 'ang20191016t200430', 'ang20191017t143318', 'ang20191017t144928', 'ang20191017t150903',
                      'ang20191017t152518', 'ang20191017t154425', 'ang20191017t160033', 'ang20191017t161837', 'ang20191017t163235',
                      'ang20191017t164928', 'ang20191017t170330', 'ang20191017t171949', 'ang20191017t173348', 'ang20191017t174946',
                      'ang20191017t180347', 'ang20191017t182024', 'ang20191017t183448', 'ang20191017t185057', 'ang20191017t191119',
                      'ang20191018t141549', 'ang20191018t144405', 'ang20191018t150906', 'ang20191018t153724', 'ang20191018t160154',
                      'ang20191018t163108', 'ang20191018t165503', 'ang20191018t172239', 'ang20191018t174629', 'ang20191018t181457',
                      'ang20191018t183859', 'ang20191018t190719', 'ang20191019t145204', 'ang20191019t150925', 'ang20191019t151749',
                      'ang20191019t152610', 'ang20191019t153454', 'ang20191019t155740', 'ang20191019t160518', 'ang20191019t161418',
                      'ang20191019t162211', 'ang20191019t163936', 'ang20191019t164827', 'ang20191019t170014', 'ang20191019t171416',
                      'ang20191019t172500', 'ang20191019t173905', 'ang20191019t175004', 'ang20191019t181857', 'ang20191019t182848',
                      'ang20191019t183727', 'ang20191019t184718', 'ang20191019t185452', 'ang20191021t153008', 'ang20191021t154726',
                      'ang20191021t160052', 'ang20191021t161810', 'ang20191021t163119', 'ang20191021t164905', 'ang20191021t170142',
                      'ang20191021t171902', 'ang20191021t173221', 'ang20191021t174954', 'ang20191021t180251', 'ang20191021t181927',
                      'ang20191021t183204', 'ang20191021t184841', 'ang20191021t190136', 'ang20191021t191828', 'ang20191021t193145',
                      'ang20191021t194835', 'ang20191022t143154', 'ang20191022t150110', 'ang20191022t151202', 'ang20191022t152357',
                      'ang20191022t153425', 'ang20191022t154405', 'ang20191022t162321', 'ang20191022t163722', 'ang20191022t164918',
                      'ang20191022t165908', 'ang20191022t171226', 'ang20191022t172245', 'ang20191022t173357', 'ang20191022t175031',
                      'ang20191022t180237', 'ang20191022t181138', 'ang20191022t182432', 'ang20191022t183431', 'ang20191022t184525',
                      'ang20191022t190019', 'ang20191022t191141', 'ang20191022t192048', 'ang20191022t193257', 'ang20191022t194233',
                      'ang20191022t194943', 'ang20191023t142135', 'ang20191023t145837', 'ang20191023t151141', 'ang20191023t152801',
                      'ang20191023t154154', 'ang20191023t155808', 'ang20191023t161300', 'ang20191023t162847', 'ang20191023t164221',
                      'ang20191023t165811', 'ang20191023t172753', 'ang20191023t174017', 'ang20191023t175603', 'ang20191023t180821',
                      'ang20191023t182357', 'ang20191023t183654', 'ang20191023t185210', 'ang20191023t190429', 'ang20191023t191942',
                      'ang20191023t193139', 'ang20191023t194035', 'ang20191025t161146', 'ang20191025t163632', 'ang20191025t165545',
                      'ang20191025t171141', 'ang20191025t173025', 'ang20191025t174619', 'ang20191025t182152', 'ang20191025t184057',
                      'ang20191025t185816', 'ang20191025t191752', 'ang20191025t193513', 'ang20191025t195446', 'ang20191025t203400',
                      'ang20191025t205201']


NAME_FILES_JPL_4CORNERS =['ang20150419t155032', 'ang20150419t161445', 'ang20150419t163741', 'ang20150419t172431', 'ang20150419t174758',
                          'ang20150419t181127', 'ang20150419t185922', 'ang20150419t192226', 'ang20150419t194538', 'ang20150419t221127',
                          'ang20150419t223618', 'ang20150419t224329', 'ang20150419t225205', 'ang20150419t230200', 'ang20150419t230603',
                          'ang20150419t231105', 'ang20150420t153209', 'ang20150420t155846', 'ang20150420t161618', 'ang20150420t162455',
                          'ang20150420t163424', 'ang20150420t164200', 'ang20150420t165116', 'ang20150420t170010', 'ang20150420t170855',
                          'ang20150420t171715', 'ang20150420t172540', 'ang20150420t173533', 'ang20150420t174355', 'ang20150420t180624',
                          'ang20150420t182050', 'ang20150420t182808', 'ang20150420t183606', 'ang20150420t184333', 'ang20150420t185149',
                          'ang20150420t185951', 'ang20150420t190759', 'ang20150421t160854', 'ang20150421t170417', 'ang20150421t172847',
                          'ang20150421t175040', 'ang20150421t181252', 'ang20150421t183438', 'ang20150421t185811', 'ang20150421t192110',
                          'ang20150421t194335', 'ang20150421t200517']


from multiprocessing import get_context
import os
from Plume_Finder import process_aviris, utils
from datetime import datetime
import argparse
import numpy as np


def main(idx, name:str, n_images:int,
         path_save_images:str,
         path_untar_folder_base:str,
         remove_untar_file:bool=True,
         remove_path_tiffs_temp:bool=True,
         path_targz_base:str=".",
         path_geotiff_base:str=".",
         disable_pbar:bool =True,
         samples_read:int=50):

    fs = utils.get_filesystem(path_save_images)
    # Folder to save all the products
    folder_dest_bucket = os.path.join(path_save_images, name)

    # Files expected from mag1c code
    path_dest_mf = os.path.join(folder_dest_bucket, "mag1c.tif")
    path_dest_albedo = os.path.join(folder_dest_bucket, "albedo.tif")
    path_dest_glt = os.path.join(folder_dest_bucket, "glt.tif")

    donot_download = all((fs.exists(f) for f in [path_dest_mf, path_dest_albedo, path_dest_glt]))

    # Files expected from save as COG process
    filename_dest_json = os.path.join(folder_dest_bucket, "metadata.json")
    donot_download = donot_download and fs.exists(filename_dest_json)

    if donot_download:
        metadata = utils.read_json_from_gcp(filename_dest_json)
        donot_download = all(fs.exists(os.path.join(folder_dest_bucket, f"{i}.tif")) for i in range(len(metadata["wavelengths"])))

    # # Files expected by convert to S2 process
    all_products_exist = donot_download
    if all_products_exist:
        all_products_exist = all(
            fs.exists(os.path.join(folder_dest_bucket, f"{sensor}_{band}.tif")) for sensor in ["S2A","S2B","WV3"] for band in process_aviris.BANDS_SENSOR[sensor])

    if all_products_exist:
        print(f"{datetime.now().strftime('%Y-%m-%d %H:%M:%S')} ({idx + 1}/{n_images}) {name} All products exist")
        return

    aviris_folder = None
    path_tiffs_temp = os.path.join(path_geotiff_base, name)
    os.makedirs(path_tiffs_temp, exist_ok=True)

    if not donot_download:
        print(f"{datetime.now().strftime('%Y-%m-%d %H:%M:%S')} ({idx + 1}/{n_images}) {name} downloading and untar")
        filename_down, aviris_folder = process_aviris.download_aviris(name, path_targz_base=path_targz_base,
                                                                      path_untar_folder_base=path_untar_folder_base,
                                                                      remove_targz_file=True,
                                                                      display_progress_bar_download=not disable_pbar)

    # convert image to COG GeoTIFFs with each band stored in a separate file
        print(f"{datetime.now().strftime('%Y-%m-%d %H:%M:%S')} ({idx + 1}/{n_images}) {name} save as COG")
        process_aviris.save_aviris_cog(aviris_img_folder=aviris_folder, folder_dest=folder_dest_bucket,
                                       path_tiffs_temp=path_tiffs_temp,disable_pbar=disable_pbar)

        # Run mag1c and saves mf, albedo and glt file as COG
        print(f"{datetime.now().strftime('%Y-%m-%d %H:%M:%S')} ({idx + 1}/{n_images}) {name} running mag1c")
        process_aviris.run_mag1c(aviris_folder, mf_filename=path_dest_mf, albedo_filename=path_dest_albedo,
                                 glt_filename=path_dest_glt,disable_pbar=disable_pbar,
                                 path_tiffs_temp=path_tiffs_temp, samples_read=samples_read)

    # Simulate Sentinel-2 bands from images
    print(f"{datetime.now().strftime('%Y-%m-%d %H:%M:%S')} ({idx + 1}/{n_images}) {name} Simulating S2")

    if aviris_folder is None:
        # IF none we will read the AVIRIS image from the bucket
        aviris_folder = folder_dest_bucket

    process_aviris.aviris_as_sensor(aviris_folder, folder_dest_bucket, path_tiffs_temp=path_tiffs_temp,
                                    disable_pbar=disable_pbar, columns_read=samples_read)

    # Remove aviris_folder
    if remove_untar_file:
        utils.remove_folder(aviris_folder)

    if remove_path_tiffs_temp:
        utils.remove_folder(path_tiffs_temp)

    print(f"{datetime.now().strftime('%Y-%m-%d %H:%M:%S')} ({idx + 1}/{n_images}) {name} Finished")



if __name__ == "__main__":

    PATH_TAR_GZ_BASE = "/AVIRISNG/targz"
    PATH_UNTAR_FOLDER_BASE = "/mnt/disk2/AVIRISNG/untar"
    PATH_GEOTIFF_BASE = "/mnt/disk2/AVIRISNG/geotiff"

    parser = argparse.ArgumentParser(usage="Downloads AVIRIS images, convert them to COG geoTIFF with a file for each band, "
                                           "run mag1c on the AVIRIS image, save methane enhancement, albedo and glt info, "
                                           "run aviris to S2 conversion and save each of the S2 simulated bands")
    parser.add_argument('--database', type=str, required=True,
                        help=f'Name of the database or AVIRIS-NG image to download '
                             f'"4corners", "permian", "ang20190927t145113"')
    parser.add_argument('--folder_save', type=str,
                        help='Folder to write outputs (will be stored in folder/{aviris_name}/xxx.tif)')
    parser.add_argument('--path_untar_folder_base', type=str,
                        default=PATH_UNTAR_FOLDER_BASE,
                        help='Folder to untar targz AVIRIS images (default: %(default)s)')
    parser.add_argument('--path_targz_base', type=str,
                        default=PATH_TAR_GZ_BASE,
                        help='Folder to download TARGZ AVIRIS images (default: %(default)s)')
    parser.add_argument('--path_geotiff_base', type=str,
                        default=PATH_GEOTIFF_BASE,
                        help='Folder to save temporal geotiff files (default: %(default)s)')
    parser.add_argument('--remove_untar_file', action='store_true',
                        help='Remove untar file after processing')
    parser.add_argument('--num_processes', type=int, default=6,
                        help='Number of processes to run in parallel. (default: %(default)s)')
    parser.add_argument('--samples_read', type=int, default=50,
                        help='Number of columns to read from AVIRIS (default: %(default)s)')

    args = parser.parse_args()


    os.makedirs(args.path_targz_base, exist_ok=True)
    os.makedirs(args.path_untar_folder_base, exist_ok=True)
    os.makedirs(args.path_geotiff_base, exist_ok=True)

    if args.database == "4corners":
        name_files = NAME_FILES_JPL_4CORNERS
    elif args.database == "permian":
        name_files = NAME_FILES_PERMIAN
    else:
        name_files = [args.database]

    if args.folder_save:
        folder_save = args.folder_save
    else:
        if args.database == "4corners":
            folder_save = "gs://Plume_Finder/JPL-CG4-detection-2017/data"
        elif args.database == "permian":
            folder_save = "gs://Plume_Finder/Permian/data"
        else:
            folder_save = "."

    n_files = len(name_files)
    num_processes = min(args.num_processes, n_files)
    name_files = np.random.permutation(np.array(name_files))

    if num_processes <= 1:
        for idx, n in enumerate(name_files):
            main(idx, n, n_files, folder_save, args.path_untar_folder_base, args.remove_untar_file,
                 True, args.path_targz_base, args.path_geotiff_base,False, args.samples_read)
    else:
        with get_context("spawn").Pool(num_processes) as p:
            p.starmap(main,[(idx, n, n_files,folder_save ,args.path_untar_folder_base,args.remove_untar_file,
                             True, args.path_targz_base, args.path_geotiff_base,True, args.samples_read)
                               for idx,n in enumerate(name_files)], chunksize=6)
